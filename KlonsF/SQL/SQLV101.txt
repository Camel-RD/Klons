SET TERM ^ ;


ALTER PROCEDURE SP_DIFF_11(
  PDATE1 DATE,
  PDATE2 DATE,
  PDATE3 DATE)
RETURNS (
  IDL1 TYPE OF COLUMN LOPSD.IDL,
  IDL2 TYPE OF COLUMN LOPS.IDL,
  DOCID TYPE OF COLUMN LOPSD.ID,
  ROWID TYPE OF COLUMN LOPS.ID)
AS
begin
    for select distinct
        idl1, idl2, docid, rowid
    from
    (
        select
            T3.idl as idl1,
            T4.idl as idl2,
            T3.id as docid,
            T4.id as rowid
        from
        (
            select T1.idl, T1.id
            from lopsd as T1
            where
                T1.dete between :pdate1 and :pdate2 and
                T1.odt < :pdate3 and
                not exists (
                    select idl
                    from lopsd as T2
                    where
                        T2.id = T1.id and
                        T2.odt < :pdate3 and
                        (T2.odt > T1.odt or
                        T2.odt = T1.odt and
                        T2.idl > T1.idl)
                )
        ) as T3
        join lops as T4
        on T3.id = T4.docid and
            T4.odt < :pdate3 and
            not exists (
                select idl
                from lops as T5
                where
                    T5.id = T4.id and
                    T5.odt < :pdate3 and
                    (T5.odt > T4.odt or
                    T5.odt = T4.odt and
                    T5.idl > T4.idl)
                    
            )

        union all

        select
            T4.idl as idl1,
            null as idl2,
            T4.id as docid,
            T5.id as rowid
        from
        (
            select T1.idl, T1.id
            from lopsd as T1
            where
                T1.dete between :pdate1 and :pdate2 and
                T1.odt < :pdate3 and
                not exists (
                    select idl
                    from lopsd as T2
                    where
                        T2.id = T1.id and
                        T2.odt < :pdate3 and
                        (T2.odt > T1.odt or
                        T2.odt = T1.odt and
                        T2.idl > T1.idl)
                )
                and not exists (
                    select idl
                    from lops as T3
                    where T3.docid = T1.id
                )
        ) as T4
        join ops as T5
        on T5.id = T4.id and
            T5.zdt < :pdate3
    )
    into
        :idl1, :idl2, :docid, :rowid
    do
    suspend;
end
^

ALTER PROCEDURE SP_DIFF_12(
  PDATE1 DATE,
  PDATE2 DATE,
  PDATE3 DATE,
  PCLID VARCHAR(15),
  PAC1 VARCHAR(8),
  PAC2 VARCHAR(8),
  PAC3 VARCHAR(5),
  PAC4 VARCHAR(8),
  PAC5 VARCHAR(5))
RETURNS (
  TP INTEGER,
  DOCID TYPE OF COLUMN OPS.DOCID,
  ROWID TYPE OF COLUMN OPS.ID,
  DOCDTL TIMESTAMP,
  DOCDTLD TIMESTAMP,
  DOCODT TIMESTAMP,
  ROWDTL TIMESTAMP,
  ROWDTLD TIMESTAMP,
  ROWODT TIMESTAMP,
  DETE TYPE OF COLUMN OPSD.DETE,
  ZNR TYPE OF COLUMN OPSD.ZNR,
  NRX TYPE OF COLUMN OPSD.NRX,
  DOCTYP TYPE OF COLUMN OPSD.DOCTYP,
  DOCST TYPE OF COLUMN OPSD.DOCST,
  DOCNR TYPE OF COLUMN OPSD.DOCNR,
  DOCTYP2 TYPE OF COLUMN DOCTYP.ID1,
  CLID TYPE OF COLUMN OPSD.CLID,
  CLID2 TYPE OF COLUMN OPSD.CLID2,
  DESCR TYPE OF COLUMN OPSD.DESCR,
  DOCSUMM TYPE OF COLUMN OPSD.SUMM,
  DOCPVN TYPE OF COLUMN OPSD.PVN,
  AC11 TYPE OF COLUMN OPS.AC11,
  AC12 TYPE OF COLUMN OPS.AC12,
  AC13 TYPE OF COLUMN OPS.AC13,
  AC14 TYPE OF COLUMN OPS.AC14,
  AC15 TYPE OF COLUMN OPS.AC15,
  AC21 TYPE OF COLUMN OPS.AC21,
  AC22 TYPE OF COLUMN OPS.AC22,
  AC23 TYPE OF COLUMN OPS.AC23,
  AC24 TYPE OF COLUMN OPS.AC24,
  AC25 TYPE OF COLUMN OPS.AC25,
  SUMMC TYPE OF COLUMN OPS.SUMMC,
  CUR TYPE OF COLUMN OPS.CUR,
  SUMM TYPE OF COLUMN OPS.SUMM,
  QV TYPE OF COLUMN OPS.QV,
  DESCR2 TYPE OF COLUMN OPS.DESCR)
AS
begin

    insert into
    ttemp_diff2(idl1, idl2, docid, rowid)
    select distinct idl1, idl2, docid, rowid
    from sp_diff_11(:pdate1, :pdate2, :pdate3) as T1
    where exists (
        select idl
        from lopsd
        where
            T1.docid = lopsd.id and
            lopsd.dtld > :pdate3

        union all

        select idl
        from lops
        where
            T1.rowid = lops.id and
            lops.dtld > :pdate3

        union all

        select id
        from opsd
        where
            T1.docid = opsd.id and
            opsd.zdt > :pdate3

        union all

        select id
        from ops
        where
            T1.rowid = ops.id and
            ops.zdt > :pdate3
    );

    for select distinct *
    from
    (
        select
            1 as tp,
            lops.docid, lops.id as rowid,
            lopsd.zdt as docdtl, lopsd.dtld as docdtld, lopsd.odt as docodt,
            lops.dtl as rowdtl, lops.dtld as rowdtld, lops.odt as rowodt,
            lopsd.dete, lopsd.znr, lopsd.nrx,
            lopsd.doctyp, lopsd.docst, lopsd.docnr,
            lopsd.clid, lopsd.clid2, lopsd.descr, 
            lopsd.summ as docsumm, lopsd.pvn as docpvn, 
            lops.ac11,  lops.ac12, lops.ac13, lops.ac14, lops.ac15,
            lops.ac21,  lops.ac22, lops.ac23, lops.ac24, lops.ac25,
            lops.summc, lops.cur, lops.summ, lops.qv, null as descr2
    
        from ttemp_diff2 as T1
        join lopsd on T1.idl1 = lopsd.idl
        join lops on T1.idl2 = lops.idl
        where
            (:pclid is null or :pclid = lopsd.clid) and
            (:pac1 is null or :pac1 = lops.ac11 or :pac1 = lops.ac21) and
            (:pac2 is null or :pac2 = lops.ac12 or :pac2 = lops.ac22) and
            (:pac3 is null or :pac3 = lops.ac13 or :pac3 = lops.ac23) and
            (:pac4 is null or :pac4 = lops.ac14 or :pac4 = lops.ac24) and
            (:pac5 is null or :pac5 = lops.ac15 or :pac5 = lops.ac25)

    union all

        select
            1 as tp,
            lops.docid, lops.id as rowid,
            lopsd.zdt as docdtl, lopsd.dtld as docdtld, lopsd.odt as docodt,
            lops.dtl as rowdtl, lops.dtld as rowdtld, lops.odt as rowodt,
            lopsd.dete, lopsd.znr, lopsd.nrx,
            lopsd.doctyp, lopsd.docst, lopsd.docnr,
            lopsd.clid, lopsd.clid2, lopsd.descr, 
            lopsd.summ as docsumm, lopsd.pvn as docpvn, 
            lops.ac11,  lops.ac12, lops.ac13, lops.ac14, lops.ac15,
            lops.ac21,  lops.ac22, lops.ac23, lops.ac24, lops.ac25,
            lops.summc, lops.cur, lops.summ, lops.qv, null as descr2

        from ttemp_diff2 as T1
        join lopsd on T1.idl1 = lopsd.idl
        join lops on T1.idl2 = lops.idl
        join ops on T1.rowid = ops.id
        join opsd on ops.docid = opsd.id
        where
            (not (
                (:pclid is null or :pclid = lopsd.clid) and
                (:pac1 is null or :pac1 = lops.ac11 or :pac1 = lops.ac21) and
                (:pac2 is null or :pac2 = lops.ac12 or :pac2 = lops.ac22) and
                (:pac3 is null or :pac3 = lops.ac13 or :pac3 = lops.ac23) and
                (:pac4 is null or :pac4 = lops.ac14 or :pac4 = lops.ac24) and
                (:pac5 is null or :pac5 = lops.ac15 or :pac5 = lops.ac25)
            )) and (
                (:pclid is null or :pclid = opsd.clid) and
                (:pac1 is null or :pac1 = ops.ac11 or :pac1 = ops.ac21) and
                (:pac2 is null or :pac2 = ops.ac12 or :pac2 = ops.ac22) and
                (:pac3 is null or :pac3 = ops.ac13 or :pac3 = ops.ac23) and
                (:pac4 is null or :pac4 = ops.ac14 or :pac4 = ops.ac24) and
                (:pac5 is null or :pac5 = ops.ac15 or :pac5 = ops.ac25)
            )

    union all

        select
            2 as tp,
            ops.docid, ops.id as rowid,
            null as docdtl, null as docdtld, opsd.zdt as docodt,
            null as rowdtl, null as rowdtld, ops.zdt as rowodt,
            opsd.dete, opsd.znr, opsd.nrx,
            opsd.doctyp, opsd.docst, opsd.docnr,
            opsd.clid, opsd.clid2, opsd.descr,
            opsd.summ as docsumm, opsd.pvn as docpvn,
            ops.ac11,  ops.ac12, ops.ac13, ops.ac14, ops.ac15,
            ops.ac21,  ops.ac22, ops.ac23, ops.ac24, ops.ac25,
            ops.summc, ops.cur, ops.summ, ops.qv, ops.descr as descr2
    
        from ttemp_diff2 as T1
        join lopsd on T1.idl1 = lopsd.idl
        join lops on T1.idl2 = lops.idl
        join ops on T1.rowid = ops.id
        join opsd on ops.docid = opsd.id
        where
            (
                (:pclid is null or :pclid = lopsd.clid) and
                (:pac1 is null or :pac1 = lops.ac11 or :pac1 = lops.ac21) and
                (:pac2 is null or :pac2 = lops.ac12 or :pac2 = lops.ac22) and
                (:pac3 is null or :pac3 = lops.ac13 or :pac3 = lops.ac23) and
                (:pac4 is null or :pac4 = lops.ac14 or :pac4 = lops.ac24) and
                (:pac5 is null or :pac5 = lops.ac15 or :pac5 = lops.ac25)
            ) or (
                (:pclid is null or :pclid = opsd.clid) and
                (:pac1 is null or :pac1 = ops.ac11 or :pac1 = ops.ac21) and
                (:pac2 is null or :pac2 = ops.ac12 or :pac2 = ops.ac22) and
                (:pac3 is null or :pac3 = ops.ac13 or :pac3 = ops.ac23) and
                (:pac4 is null or :pac4 = ops.ac14 or :pac4 = ops.ac24) and
                (:pac5 is null or :pac5 = ops.ac15 or :pac5 = ops.ac25)
            )     

    union all

        select
            3 as tp,
            lops.docid, lops.id as rowid,
            lopsd.zdt as docdtl, lopsd.dtld as docdtld, lopsd.odt as docodt,
            lops.dtl as rowdtl, lops.dtld as rowdtld, lops.odt as rowodt,
            lopsd.dete, lopsd.znr, lopsd.nrx,
            lopsd.doctyp, lopsd.docst, lopsd.docnr,
            lopsd.clid, lopsd.clid2, lopsd.descr, 
            lopsd.summ as docsumm, lopsd.pvn as docpvn, 
            lops.ac11,  lops.ac12, lops.ac13, lops.ac14, lops.ac15,
            lops.ac21,  lops.ac22, lops.ac23, lops.ac24, lops.ac25,
            lops.summc, lops.cur, lops.summ, lops.qv, null as descr2

        from ttemp_diff2 as T1
        join lopsd on T1.idl1 = lopsd.idl
        join lops on T1.idl2 = lops.idl
        join lops as lops2 on T1.rowid = lops2.id and lops2.dtld > :pdate3
        join lopsd as lopsd2 on lopsd2.id = lops2.docid and
            not exists(
                select idl
                from lopsd as lopsd3
                where lopsd2.id = lopsd3.id and lopsd3.zdt > lopsd2.dtld
            )
        where
            (
                (:pclid is null or :pclid = lopsd.clid) and
                (:pac1 is null or :pac1 = lops.ac11 or :pac1 = lops.ac21) and
                (:pac2 is null or :pac2 = lops.ac12 or :pac2 = lops.ac22) and
                (:pac3 is null or :pac3 = lops.ac13 or :pac3 = lops.ac23) and
                (:pac4 is null or :pac4 = lops.ac14 or :pac4 = lops.ac24) and
                (:pac5 is null or :pac5 = lops.ac15 or :pac5 = lops.ac25)
            ) or (
                (:pclid is null or :pclid = lopsd2.clid) and
                (:pac1 is null or :pac1 = lops2.ac11 or :pac1 = lops2.ac21) and
                (:pac2 is null or :pac2 = lops2.ac12 or :pac2 = lops2.ac22) and
                (:pac3 is null or :pac3 = lops2.ac13 or :pac3 = lops2.ac23) and
                (:pac4 is null or :pac4 = lops2.ac14 or :pac4 = lops2.ac24) and
                (:pac5 is null or :pac5 = lops2.ac15 or :pac5 = lops2.ac25)
            )

    union all

        select
            4 as tp,
            ops.docid, ops.id as rowid,
            null as docdtl, null as docdtld, opsd.zdt as docodt,
            null as rowdtl, null as rowdtld, ops.zdt as rowodt,
            opsd.dete, opsd.znr, opsd.nrx,
            opsd.doctyp, opsd.docst, opsd.docnr,
            opsd.clid, opsd.clid2, opsd.descr,
            opsd.summ as docsumm, opsd.pvn as docpvn,
            ops.ac11,  ops.ac12, ops.ac13, ops.ac14, ops.ac15,
            ops.ac21,  ops.ac22, ops.ac23, ops.ac24, ops.ac25,
            ops.summc, ops.cur, ops.summ, ops.qv, ops.descr as descr2
    
        from
            opsd join ops
            on
                ops.docid = opsd.id and
                opsd.dete between :pdate1 and :pdate2 and
                opsd.zdt > :pdate3
            left join ttemp_diff2 as T1
            on ops.id = T1.rowid
        where
            T1.idl1 is null and
            (:pclid is null or :pclid = opsd.clid) and
            (:pac1 is null or :pac1 = ops.ac11 or :pac1 = ops.ac21) and
            (:pac2 is null or :pac2 = ops.ac12 or :pac2 = ops.ac22) and
            (:pac3 is null or :pac3 = ops.ac13 or :pac3 = ops.ac23) and
            (:pac4 is null or :pac4 = ops.ac14 or :pac4 = ops.ac24) and
            (:pac5 is null or :pac5 = ops.ac15 or :pac5 = ops.ac25)

    union all

        select
            5 as tp,
            ops.docid, ops.id as rowid,
            lopsd.zdt as docdtl, lopsd.dtld as docdtld, lopsd.odt as docodt,
            null as rowdtl, null as rowdtld, ops.zdt as rowodt,
            lopsd.dete, lopsd.znr, lopsd.nrx,
            lopsd.doctyp, lopsd.docst, lopsd.docnr,
            lopsd.clid, lopsd.clid2, lopsd.descr, 
            lopsd.summ as docsumm, lopsd.pvn as docpvn, 
            ops.ac11,  ops.ac12, ops.ac13, ops.ac14, ops.ac15,
            ops.ac21,  ops.ac22, ops.ac23, ops.ac24, ops.ac25,
            ops.summc, ops.cur, ops.summ, ops.qv, ops.descr as descr2

        from ttemp_diff2 as T1
        join lopsd on T1.idl1 = lopsd.idl and T1.idl2 = null
        join ops on T1.rowid = ops.id
        join opsd on ops.docid = opsd.id
        join opsd as opsd2 on opsd2.id = T1.docid
        where
            (
                (:pclid is null or :pclid = opsd2.clid)
            ) or (
                (:pclid is null or :pclid = opsd.clid) and
                (:pac1 is null or :pac1 = ops.ac11 or :pac1 = ops.ac21) and
                (:pac2 is null or :pac2 = ops.ac12 or :pac2 = ops.ac22) and
                (:pac3 is null or :pac3 = ops.ac13 or :pac3 = ops.ac23) and
                (:pac4 is null or :pac4 = ops.ac14 or :pac4 = ops.ac24) and
                (:pac5 is null or :pac5 = ops.ac15 or :pac5 = ops.ac25)
            )


    )
    order by docid, rowid, tp, iif(rowodt > docodt, docodt, rowodt)
    into
        :tp, :docid, :rowid,
        :docdtl, :docdtld, :docodt,
        :rowdtl, :rowdtld, :rowodt,
        :dete, :znr, :nrx, 
        :doctyp, :docst, :docnr,
        :clid, :clid2, :descr, 
        :docsumm, :docpvn,
        :ac11, :ac12, :ac13, :ac14, :ac15, 
        :ac21, :ac22, :ac23, :ac24, :ac25,
        :summc, :cur, :summ, :qv, :descr2

    do
    suspend;
end
^


SET TERM ; ^


UPDATE Params
SET PVALUE = '101'
WHERE PNAME = 'version';
